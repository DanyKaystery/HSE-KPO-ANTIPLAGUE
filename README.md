# Antiplague System 

Система проверки студенческих работ на плагиат с использованием алгоритма шинглов и микросервисной архитектуры.

---

##  Описание

**Antiplague** — это приложение, которое позволяет студентам загружать свои работы и получать отчет о проценте плагиата по сравнению с другими работами того же задания. Система также генерирует визуализацию часто встречающихся слов в текстах (облака слов).

**Основной сценарий:**
1. Студент загружает работу (`.txt` или `.md` файл).
2. Gateway сохраняет файл в Storage Service.
3. Analysis Service скачивает файл и сравнивает с другими работами того же задания.
4. Преподаватель видит результат проверки и может запросить облако слов.

---

##  Архитектура

Система состоит из 4 основных компонентов:

API Gateway (port 9090) — единая точка входа для всех клиентских запросов. Отвечает за валидацию входных данных, маршрутизацию к соответствующим сервисам и обеспечение отказоустойчивости.

Storage Service (port 9091) — микросервис для управления файлами. Обрабатывает загрузку и скачивание документов, хранит файлы локально или в облаке.

Analysis Service (port 9092) — микросервис для анализа плагиата. Выполняет сравнение текста новой работы с предыдущими, вычисляет коэффициент совпадения, используя алгоритм сравнения (shingle).

PostgreSQL (port 5433) — база данных для хранения метаданных файлов, информации о работах, результатов анализа плагиата и пользовательской информации.

Поток данных: Клиент отправляет запрос в Gateway (9090) -> Gateway маршрутизирует в Storage (9091) для загрузки файла и Analysis (9092) для проверки плагиата -> оба сервиса работают с PostgreSQL (5433) -> результат возвращается клиенту через Gateway.

### Компоненты

#### 1. **API Gateway** (cmd/gateway/main.go)
- **Порт:** 9090
- **Роль:** Публичное REST API, маршрутизация между сервисами
- **Функции:**
    - Прием и валидация загрузок файлов
    - Оркестрация: вызов Storage Service -> Analysis Service (проверка)
    - Swagger UI документация на /swagger/index.html

#### 2. **Storage Service** (cmd/storage/main.go)
- **Порт:** 9091
- **Роль:** Надежное хранение и выдача файлов
- **Функции:**
    - POST /internal/upload — сохранение файла на диск 
    - GET /internal/files/{id}/content — скачивание файла по ID
    - Метаданные хранятся в PostgreSQL

#### 3. **Analysis Service** (cmd/analysis/main.go)
- **Порт:** 9092
- **Роль:** Проверка на плагиат и генерация облака слов
- **Функции:**
    - POST /internal/analyze — сравнение работы с другими (шинглинг)
    - GET /internal/analyze/{work_id}/wordcloud — облако слов (Бонус)
    - Скачивает файлы из Storage Service
    - Сохраняет отчеты в PostgreSQL

#### 4. **PostgreSQL** 
- **Порт:** 5433 (для тестирования), внутри Docker: 5432
- **База данных:** antiplague_db
- **Таблицы:**
    - works — метаданные работ (ID, student, assignment, file_id)
    - files — информация о файлах (хранилище, путь, размер)
    - plagiarism_reports — отчеты (score, matched_work_id, статус)

---

## Алгоритм обнаружения плагиата

**W-Shingling (Оконная шингля):**

1. **Нормализация:** Текст приводится к нижнему регистру, удаляются знаки препинания.
2. **Разделение:** Текст разбивается на последовательности из 3 слов.
3. **Хеширование:** Каждой шингле вычисляется хеш.
4. **Сравнение:** Для каждой пары работ вычисляется Коэффициент Жаккара:


   Score = (Пересечение множеств хешей) / (Объединение множеств хешей)


5. **Пороговая проверка:** Если Score > 0.85 -> is_plagiarized = true.

**Сложность:** O(n), где n — количество слов в тексте.

---

## Бонусная функциональность: Облако слов

Реализована генерация визуализации часто встречающихся слов:

- **Endpoint:** GET /api/v1/works/{work_id}/wordcloud
- **Реализация:** Используется QuickChart.io API
- **Результат:** PNG-изображение со словами разного размера (частота a размер)
- **Пример ответа:**
  ```json
  {
    "word_cloud_url": "https://quickchart.io/wordcloud?text=...",
    "work_id": "a1b2c3d4-..."
  }
  ```

---

## Запуск

### Требования
- Docker Desktop (или Docker + Docker Compose)
- Порты 9090, 9091, 9092, 5433 свободны

### Команда

```bash

~/go/bin/swag init -g main.go \
  --dir ./cmd/gateway,./internal/dto \
  --output ./docs

docker compose up -d --build

docker compose ps

curl http://localhost:9090/swagger/index.html
```

### Остановка
```bash
docker compose down -v 
```

---

## Использование API

### Swagger UI
Полная интерактивная документация доступна: 
**[http://localhost:9090/swagger/index.html](http://localhost:9090/swagger/index.html)**

### Основные эндпоинты

#### 1. Загрузка работы (Основное)
```bash
curl -X POST http://localhost:9090/api/v1/works \
  -F "assignment_id=550e8400-e29b-41d4-a716-446655440000" \
  -F "student_id=123e4567-e89b-12d3-a456-426614174000" \
  -F "file=@work.txt"
```

**Ответ (202 Accepted):**
```json
{
  "success": true,
  "data": {
    "work_id": "7d6d1bbf-1a4d-46d7-b184-9b4bc37b9250",
    "submitted_at": "2025-12-10T21:58:55Z",
    "plagiarism_check": {
      "is_plagiarized": false,
      "score": 0.0,
      "status": "checked"
    }
  }
}
```

#### 2. Облако слов (Бонус)
```bash
curl http://localhost:9090/api/v1/works/7d6d1bbf-1a4d-46d7-b184-9b4bc37b9250/wordcloud
```

**Ответ (200 OK):**
```json
{
  "word_cloud_url": "https://quickchart.io/wordcloud?text=golang+docker+microservices...",
  "work_id": "7d6d1bbf-1a4d-46d7-b184-9b4bc37b9250"
}
```

#### 3. Health Check
```bash
curl http://localhost:9090/health
```

---




##  Тестирование

### Unit тесты
```bash
go test ./internal/domain/plagiarism/... -v
```

### Integration тесты (требуется запущенный сервер)
```bash
go test ./tests/integration/... -v
```

---
